Silex
-----

Основой проекта является микрофреймворк Silex. В первую очередь надо почитать документацию http://silex.sensiolabs.org/. Из неё надо понимать, что такое $app, что такое Service Provider ну и вообще не теряться в общей архитектуре. 

### Структура файлов проекта

- /vendor - то, что подтягивает composer. Руками эту папку трогать нельзя
- /public - **Document Root** проекта. Там должно быть два файла - index.php и .htaccess
    - /public/assets - файлы статики. Все css, js, картинки - всё складывается туда. 
    - /public/mockups - временные файлы верстки до переноса их в шаблоны.
- /app - основные файлы проекта.
    - /app/DB - файлы для работы с базой данных:
        - Keep/*.sql.php - файлы миграций базы данных. Используют MySQLKeeper
        - Map/*.php - сущности таблиц базы данных. Создаются при помощи PrgController::map
    - /app/cache и /app/log - папки кэша и лога соответственно. Живут в gitignore, должны быть доступны для записи туда скриптами.
    - /app/config - конфигурационные файлы: 
        - config.php - сборщик конфигов, основной подключаемый конфигурационный файл.
        - global.conf.php - основные настройки проекта.
        - dev.conf.php - перезаписывает часть конфигов global.conf.php для девелоперской версии сайта
        - prod.conf.php - перезаписывает часть конфигов global.conf.php для продакшн версии сайта
        - local.conf.php - файл лежит в .gitignore, но его можно создать и подключить туда любые свои конфиги. Очень удобно для, например, локальной базы. 
        - routes.yml - настройки роутинга (какой контроллер за какую страницу отвечает)
    - /app/Services - собственноручно написанные сервисы. То есть те, которые не живут в /vendor. Сервис - это такая штука, которая ничего не знает о вашем коде. Она самодостаточна и может использоваться в любом другом проекте просто переносом класса.
    - /app/Providers - собственноручно написанные сервис-провайдеры. То есть те, которые не живут в /vendor. Сервис-провайдеры - это такая штука, которая связывает сервисы и ваш код. Точнее: конфигурирует сервисы исходя из ваших потребностей, и возвращает нужные инстансы сервисов.
    - /app/Controllers, /app/Models - файлы моделей и контроллеров из стандартной MVC идеологии: Модели работают напрямую с данными и только с ними. Контроллеры принимают запрос от роутера, собирают данные по моделям и отдают их во вьюшки или в json.
    - /app/Views - Вьюшки. В качестве шаблонизатора используется Twig

### \App и .phpstorm.meta.php
Все сервис-провайдеры доступны в Silex через Dependency injection: `$app['twig']` вернет объект класса `\Twig_Environment`, `$app['http_cache']` - класса `\Silex\HttpCache`. Во-первых, это (т.е. класс возвращаемого объекта) довольно неочевидно и доступные методы приходится узнавать в документации. Во-вторых, это ломает автокомплит кода и статический анализ. 

В связи с этим, а так же с тем, что у PhpStorm есть довольно удобная возможность по определению классов возвращаемых объектов (http://confluence.jetbrains.com/display/PhpStorm/PhpStorm+Advanced+Metadata) было решено обернуть $app в класс. Принцип действия: 
- Вместо `$app->` юзать `\App::_()->`.
- Вместо `$app['something']` при чтении юзать `\App::_('something')` (или `\App::get('something')`).
- Вместо `$app['something'] = new SomeObj` юзать `\App::set('something', new SomeObj)`.

При этом надо также пополнять файл .phpstorm.meta.php новыми объектами, если таковые будут использоваться. Синтаксис там довольно очевиден. 

### Миграции базы данных и ORM

Общий принцип миграций читать тут https://gitlab.wlab.biz/artem/sluice/blob/master/Readme.md#sql

Примеры тут https://gitlab.wlab.biz/artem/sluice/blob/master/test/test_sql.php

Как дополнительно работать с внешними ключами можно увидеть тут https://gitlab.wlab.biz/artem/eikoncraft/tree/master/app/DB/Keep

Файлы миграций лежат в /app/DB/Keep. 

Каждая миграция делается так:
1. В нужном файле пишем нужный альтер.
2. Запускаем /prg/sqlupdate (для изменения собственно базы)
3. Запускаем /prg/sqlmap (для обновления файлов ORM-маппинга в /app/DB/Map)

Новые таблицы можно создавать либо так же, либо чуть более удобно
1. Создаём таблицу через любимый SQL-клиент (phpmyadmin, heidisql)
2. Запускаем /prg/sqldump (для автоматического создания файла в /app/DB/Keep)
3. Запускаем /prg/sqlmap (для обновления файлов ORM-маппинга в /app/DB/Map)

### TODO
1. Presenter / ViewModel (Symphony2 presenter - https://github.com/Cydonia7/CydoPresenterBundle)
2. Расширение контроллеров для Silex - https://github.com/dcousineau/orlex
3. Вкрутить нормальный роутинг (https://github.com/marcojanssen/silex-routing-service-provider)
4. Краткая дока сюда по API DB (+ActiveRecords), роутингу и контроллерам (+before/after глобальный, контроллера и действия)